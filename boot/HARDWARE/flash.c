#include "flash.h"/* * 若不使用正常的FLASH操作步骤,如直接使用强制转换来操作 * 可进行例如:val = *(uint32_t *)0x08005000;的内存读取操作 * 但不可直接写入,例如:*(uint32_t *)0x08005000 = 0xAB; */#define ProgramTimeout        ((uint32_t)0x00002000)typedef enum{	unlocked,	locked} UNLOCK_Status;/* get unlock status */UNLOCK_Status Unlock_Status(void){	return (UNLOCK_Status)(FLASH->CR >> 7);}/* return 0:err / 1:busy / 2:PG_err / 3:WRP_err / 4:finish / 5:timeout */uint8_t FLASH_Write_HalfWord(uint32_t addr, uint16_t val){	/* Wait for last operation to be completed */	if(FLASH_WaitForLastOperation(ProgramTimeout) == FLASH_COMPLETE)	{		FLASH_Status status;				/* unlock if locked */		if( Unlock_Status() == locked )			FLASH_Unlock();				/* Memory address alignment */		if( addr % 2 != 0 )			return 0;				/* 		 * 标准编程中FPEC首先读出指定地址的内容，		 * 若地址内容不是被擦除的值，则FLASH_SR的PGERR位置1，表示编程错误			 * (若写入的值为0，则不会触发，允许正常写入)		 */		if(*(uint16_t *)addr != 0xFFFF && val != 0)			return 0;				/* write */		status = FLASH_ProgramHalfWord(addr, val);				/* lock */		FLASH_Lock();				return status;	}	else	{		return 0;	}}/* return 0:err / 1:busy / 2:PG_err / 3:WRP_err / 4:finish / 5:timeout */uint8_t FLASH_Write_Word(uint32_t addr, uint32_t val){	/* Wait for last operation to be completed */	if(FLASH_WaitForLastOperation(ProgramTimeout) == FLASH_COMPLETE)	{		FLASH_Status status;				/* unlock if locked */		if( Unlock_Status() == locked )			FLASH_Unlock();				/* Memory address alignment */		if( addr % 2 != 0 )			return 0;				/* 		 * 标准编程中FPEC首先读出指定地址的内容，		 * 若地址内容不是被擦除的值，则FLASH_SR的PGERR位置1，表示编程错误			 * (若写入的值为0，则不会触发，允许正常写入)		 */		if(*(uint32_t *)addr != 0xFFFFFFFF && val != 0)			return 0;				/* write */		status = FLASH_ProgramWord(addr, val);				/* lock */		FLASH_Lock();				return status;	}	else	{		return 0;	}}/* return 0:err / 1:busy / 2:PG_err / 3:WRP_err / 4:finish / 5:timeout *//* The address can be any one of the pages */uint8_t FLASH_Erase_Page(uint32_t Page_addr){		/* Wait for last operation to be completed */	if(FLASH_WaitForLastOperation(ProgramTimeout) == FLASH_COMPLETE)	{		FLASH_Status status;				/* unlock if locked */		if( Unlock_Status() == locked )			FLASH_Unlock();				/* erase */		status = FLASH_ErasePage(Page_addr);				/* lock */		FLASH_Lock();				return status;	}	else	{		return 0;	}}